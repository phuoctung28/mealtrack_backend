name: Build and Push to ECR

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'src/**'
      - 'Dockerfile'
      - 'requirements.txt'
      - '.github/workflows/ecr-build-push.yml'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Custom image tag'
        required: false
        default: 'latest'

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: mealtrack-backend

jobs:
  build-and-push:
    name: ðŸ³ Build and Push to ECR
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ðŸ”‘ Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: ðŸ·ï¸ Generate tags
        id: tags
        run: |
          # Generate various tags
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          GIT_COMMIT=$(git rev-parse --short HEAD)

          # Determine base tag
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "${{ github.event.inputs.tag }}" ]; then
            BASE_TAG="${{ github.event.inputs.tag }}"
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            BASE_TAG="latest"
          elif [ "${{ github.ref }}" == "refs/heads/develop" ]; then
            BASE_TAG="develop"
          else
            BASE_TAG="branch-$(echo ${GITHUB_REF#refs/heads/} | sed 's/\//-/g')"
          fi

          echo "base_tag=${BASE_TAG}" >> $GITHUB_OUTPUT
          echo "timestamp_tag=${TIMESTAMP}" >> $GITHUB_OUTPUT
          echo "commit_tag=${GIT_COMMIT}" >> $GITHUB_OUTPUT
          echo "run_tag=run-${GITHUB_RUN_NUMBER}" >> $GITHUB_OUTPUT

      - name: ðŸ³ Build Docker image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          BASE_TAG: ${{ steps.tags.outputs.base_tag }}
          TIMESTAMP_TAG: ${{ steps.tags.outputs.timestamp_tag }}
          COMMIT_TAG: ${{ steps.tags.outputs.commit_tag }}
          RUN_TAG: ${{ steps.tags.outputs.run_tag }}
        run: |
          # Build image with multiple tags
          docker build \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:$BASE_TAG \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:$TIMESTAMP_TAG \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:$COMMIT_TAG \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:$RUN_TAG \
            --build-arg BUILD_DATE="$(date -u +'%Y-%m-%dT%H:%M:%SZ')" \
            --build-arg VERSION="$COMMIT_TAG" \
            --build-arg VCS_REF="${{ github.sha }}" \
            .

      - name: ðŸ“¦ Push to ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          BASE_TAG: ${{ steps.tags.outputs.base_tag }}
          TIMESTAMP_TAG: ${{ steps.tags.outputs.timestamp_tag }}
          COMMIT_TAG: ${{ steps.tags.outputs.commit_tag }}
          RUN_TAG: ${{ steps.tags.outputs.run_tag }}
        run: |
          # Push all tags
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$BASE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$TIMESTAMP_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$COMMIT_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$RUN_TAG

      - name: ðŸ” Scan image for vulnerabilities
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          BASE_TAG: ${{ steps.tags.outputs.base_tag }}
        run: |
          aws ecr start-image-scan \
            --repository-name $ECR_REPOSITORY \
            --image-id imageTag=$BASE_TAG \
            --region ${{ env.AWS_REGION }}

      - name: ðŸ“Š Image Summary
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          BASE_TAG: ${{ steps.tags.outputs.base_tag }}
        run: |
          echo "## ðŸ³ ECR Image Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Image Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Registry:** \`$ECR_REGISTRY\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository:** \`$ECR_REPOSITORY\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Tags Published" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ steps.tags.outputs.base_tag }}\` (base)" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ steps.tags.outputs.timestamp_tag }}\` (timestamp)" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ steps.tags.outputs.commit_tag }}\` (commit)" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ steps.tags.outputs.run_tag }}\` (run number)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Pull Commands" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "docker pull $ECR_REGISTRY/$ECR_REPOSITORY:$BASE_TAG" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment" >> $GITHUB_STEP_SUMMARY
          echo "Use this image URI in your ECS task definition:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
          echo "\"image\": \"$ECR_REGISTRY/$ECR_REPOSITORY:$BASE_TAG\"" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

    outputs:
      registry: ${{ steps.login-ecr.outputs.registry }}
      image: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}
      base_tag: ${{ steps.tags.outputs.base_tag }}
      timestamp_tag: ${{ steps.tags.outputs.timestamp_tag }}
      commit_tag: ${{ steps.tags.outputs.commit_tag }}

  trigger-deployment:
    name: ðŸš€ Trigger ECS Deployment
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: ðŸ“¢ Notify deployment available
        run: |
          echo "## ðŸš€ Deployment Ready" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "New image is ready for deployment:" >> $GITHUB_STEP_SUMMARY
          echo "- **Image:** \`${{ needs.build-and-push.outputs.image }}:${{ needs.build-and-push.outputs.base_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To deploy, run the **Deploy to AWS ECS** workflow manually." >> $GITHUB_STEP_SUMMARY